<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>魔戒TRPG - 自动人物卡生成器</title>
    <style>
        :root {
            --main-font: 'Ringbearer', 'Microsoft YaHei', 'SimHei', 'KaiTi', 'STKaiti', 'serif';
            --border-color: #b7433c;
            --text-color: #3a2d1d;
            --background-color: #f7f3e9;
            --input-underline-color: #d1c5b0;
        }

        @font-face {
            font-family: 'Ringbearer';
            src: url('ringbearer.ttf') format('truetype');
        }

        body {
            font-family: var(--main-font);
            background-color: #e0dace;
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            font-size: 14px;
            line-height: 1.5;
        }

        .character-sheet {
            max-width: 1200px;
            margin: auto;
            border: 2px solid var(--border-color);
            padding: 15px;
            background: #faf0e6;
            box-shadow: var(--box-shadow);
        }

        h1, h2, legend {
            color: var(--border-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 5px;
            font-weight: bold;
        }
        h1 { text-align: center; margin-bottom: 15px; }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            gap: 15px;
        }

        input[type="text"], input[type="number"], textarea, select {
            width: 100%;
            padding: 8px;
            box-sizing: border-box;
            border: 1px solid #c8a077;
            background-color: var(--input-bg);
            border-radius: 4px;
            font-family: Ringbearer;
        }

        input[readonly], input.readonly {
            background-color: #eee;
            cursor: default;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        .header-info {
            grid-column: span 12;
            display: grid;
            grid-template-columns: repeat(12, 1fr); /* 9 columns for info, 3 for portrait */
            grid-template-rows: repeat(4, 50px); /* Adjusted rows for new diamond boxes */
            gap: 15px;
            align-items: start;
            padding-bottom: 0;
        }

        .portrait-box {
            grid-column: 10 / span 3;
            grid-row: 1 / 6;
            text-align: center;
        }

        #portrait_preview {
            width: 150px;
            height: 150px;
            border: 2px solid var(--border-color);
            background: #fff;
            object-fit: cover;
            border-radius: 4px;
            margin: 0 auto;
        }

        .portrait-controls {
            margin-top: 8px;
        }

        .custom-file-upload {
            border: 1px solid #8b4513;
            display: inline-block;
            padding: 6px 12px;
            cursor: pointer;
            background-color: #8b4513;
            color: white;
            border-radius: 4px;
            font-size: 0.9em;
        }

        input[type="file"] {
            display: none;
        }

        .attributes-section, .skills-section, .combat-features-section, .gear-section {
            display: contents;
        }

        .info-item {
            display: flex;
            flex-direction: column;
        }

        .info-item label {
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        /* --- Grid Placement for Header Info Items --- */
        .info-item.char-name { grid-column: 1 / span 2; grid-row: 1; }
        .info-item.heroic-culture { grid-column: 3 / span 2; grid-row: 1; }
        .info-item.char-age { grid-column: 5 / span 1; grid-row: 1; }
        .info-item.char-living-standard { grid-column: 6 / span 1; grid-row: 1; }
        .info-item.game-mode { grid-column: 7 / span 1; grid-row: 1; } /* MODIFIED */
        .info-item.status-checks { grid-column: 8 / span 2; grid-row: 1; } /* MODIFIED */


        .info-item.wound-severity { grid-column: 8 / span 2; grid-row: 2; }
        .info-item.cultural-blessing { grid-column: 1 / span 2; grid-row: 2 / 4; }
        .info-item.calling { grid-column: 3 / span 2; grid-row: 2; }
        .info-item.shadow-path { grid-column: 5 / span 2; grid-row: 2; }
        .info-item.char-patron { grid-column: 3 / span 2; grid-row: 3; }
        .info-item.flaw { grid-column: 5 / span 2; grid-row: 3; }

        .info-item.char-treasure { grid-column: 3 / span 1; grid-row: 4; }
        .info-item.adventure-points { grid-column: 4 / span 1; grid-row: 4; }
        .info-item.skill-points { grid-column: 5 / span 1; grid-row: 4; }
        .info-item.fellowship-points { grid-column: 6 / span 1; grid-row: 4; }

        .status-checkbox-group, .game-mode-group { /* MODIFIED */
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        .game-mode-group label { /* MODIFIED */
            margin-bottom: 0;
        }
        
        /* NEW: Container for small diamond boxes in header */
        .secondary-stats-container {
            grid-column: 7 / span 4;
            grid-row: 3 / span 3;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding-top: 10px;
        }

        #personal_traits_section h2 { margin-top: 0; }
        .description-box { margin-top: 8px; font-size: 0.9em; min-height: 60px; padding: 5px; background: #fff; border: 1px dashed #c8a077; border-radius: 4px; white-space: pre-wrap; }
        #king_of_men_bonus { margin-top: 8px; padding: 5px; background-color: #fff; border: 1px solid var(--border-color); border-radius: 4px; }
        #king_of_men_bonus:not(.hidden) { display: grid; grid-template-columns: repeat(2, 1fr); gap: 5px; }
        #king_of_men_bonus button { margin: 0px; padding: 0px 2px; font-family: Ringbearer; }
        .hidden { display: none; }

        /* --- Diamond Attribute Box Styles --- */
        .diamond-box {
            border: 2px solid var(--border-color);
            transform: rotate(45deg);
            position: relative;
        }
        .diamond-content {
            width: 100%;
            height: 100%;
            transform: rotate(-45deg);
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .diamond-box .attr-title { position: absolute; font-weight: bold; color: var(--border-color); text-align: center; width: 100%; }
        .diamond-box .attr-derived { position: absolute; text-align: center; width: 100%; }
        .diamond-box .attr-tn, .diamond-box .attr-val { position: absolute; text-align: center; }
        .diamond-box .attr-tn input, .diamond-box .attr-val input { border: 1px solid var(--border-color); text-align: center; padding: 0; background-color: white; }

        /* Large Diamond Box Styles (Main Attributes) */
        .diamond-box:not(.diamond-box-small) { width: 180px; height: 180px; margin: 25px auto; }
        .diamond-box:not(.diamond-box-small) .attr-title { top: 12px; font-size: 1.6em; }
        .diamond-box:not(.diamond-box-small) .attr-derived { bottom: 12px; font-size: 1.2em; }
        .diamond-box:not(.diamond-box-small) .attr-tn, .diamond-box:not(.diamond-box-small) .attr-val { width: 60px; }
        .diamond-box:not(.diamond-box-small) .attr-tn { left: 0px; }
        .diamond-box:not(.diamond-box-small) .attr-val { right: 0px; }
        .diamond-box:not(.diamond-box-small) .attr-tn label, .diamond-box:not(.diamond-box-small) .attr-val label { font-size: 1.1em; }
        .diamond-box:not(.diamond-box-small) .attr-tn input, .diamond-box:not(.diamond-box-small) .attr-val input { width: 50px; height: 50px; font-size: 1.5em; }

        /* NEW: Small Diamond Box Styles (Header) */
        .diamond-box-small { width: 120px; height: 120px; margin: 10px auto; }
        .diamond-box-small .attr-title { top: 6px; font-size: 1em; }
        .diamond-box-small .attr-derived { bottom: 23px; font-size: 1.2em; }
        .diamond-box-small .attr-tn, .diamond-box-small .attr-val { top: 12px; width: 45px; }
        .diamond-box-small .attr-tn { left: 5px; }
        .diamond-box-small .attr-val { right: 5px; }
        .diamond-box-small .attr-tn label, .diamond-box-small .attr-val label { font-size: 1em; }
        .diamond-box-small .attr-tn input, .diamond-box-small .attr-val input { width: 34px; height: 34px; font-size: 1.2em; }
        
        .current-stat-input-diamond { width: 38px !important; padding: 1px !important; text-align: center; font-size: 1em !important; display: inline-block; vertical-align: middle; margin-left: 4px; }

        .skills-column { grid-column: span 4; padding: 10px; }
        .skills-column h2 { margin-top: 0; text-align: center; }

        /* MODIFIED: Skill Item Layout */
        .skill-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }
        .specialization-container {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.9em;
        }
        .specialization-container input[type="checkbox"] {
            width: 16px;
            height: 16px;
            margin: 0;
            flex-shrink: 0;
        }
        .skill-item > .skill-name-label {
            flex-grow: 1;
            margin: 0;
        }

        .skill-ranks { display: flex; }
        .skill-ranks input[type="checkbox"] { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; border: 1px solid var(--border-color); margin: 0 2px; cursor: pointer; position: relative; }
        .skill-ranks input[type="checkbox"]::before { content: ''; position: absolute; top: 50%; left: 50%; width: 14px; height: 14px; background-color: var(--border-color); transform: translate(-50%, -50%) scale(0); transition: transform 0.2s ease-in-out; }
        .skill-ranks input[type="checkbox"]:checked::before { transform: translate(-50%, -50%) scale(1); }
        .section-break { grid-column: span 12; border-top: 2px solid var(--border-color); margin-top: 10px; }
        .combat-proficiencies, .feature-box { grid-column: span 4; padding: 10px; }
        .feature-box .info-item { margin-top: 10px; }
        #personal_traits_section { grid-column: span 12; }
        .traits-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .trait-box { padding: 10px; border: 1px solid #c8a077; border-radius: 4px; background-color: var(--header-bg); }
        .gear-table { grid-column: span 12; }
        .gear-table table { width: 100%; border-collapse: collapse; }
        .gear-table th, .gear-table td { border: 1px solid var(--border-color); padding: 8px; text-align: center; }
        .gear-table th { background-color: var(--header-bg); }
        .gear-table input { text-align: center; }
        .gear-controls { margin-top: 5px; text-align: right; }
        .gear-controls button, .remove-row-btn, .select-protective-gear-btn, .clear-protective-gear-btn { background-color: #8b4513; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer; font-family: Ringbearer; }
        .remove-row-btn, .clear-protective-gear-btn { background-color: #c04040; }
        .buttons-section { grid-column: span 12; text-align: center; padding-top: 20px; }
        .buttons-section button { padding: 10px 20px; margin: 0 10px; font-family: Ringbearer; font-size: 1em; background-color: var(--border-color); color: white; border: none; border-radius: 5px; cursor: pointer; box-shadow: var(--box-shadow); }
        .buttons-section button:hover { opacity: 0.9; }
        .short-input { max-width: 80px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; transition: opacity 0.3s ease; }
        .modal-content { background-color: var(--background-color); padding: 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); border: 2px solid var(--border-color); width: 90%; max-width: 500px; }
        .modal-content h2 { margin-top: 0; text-align: center; }
        .modal-form-item { margin-bottom: 15px; }
        .modal-form-item label { display: block; margin-bottom: 5px; }
        .modal-buttons { text-align: right; margin-top: 20px; }
        .modal-buttons button { padding: 8px 16px; margin-left: 10px; font-family: Ringbearer; font-size: 1em; background-color: var(--border-color); color: white; border: none; border-radius: 5px; cursor: pointer; }
        .modal-buttons button[type="button"] { background-color: #a9a9a9; }
        .modal-overlay.hidden { display: none; }
        @media (max-width: 992px) { .attributes-section > div, .skills-column, .combat-proficiencies, .feature-box { grid-column: span 12 !important; } .traits-container { grid-template-columns: 1fr; } .header-info { display: flex; flex-wrap: wrap; } .info-item { width: 48%; } .portrait-box { order: -1; width: 100%; margin-bottom: 15px; } .secondary-stats-container { order: 1; width: 100%; } }
        @media (max-width: 768px) { .points-container { grid-template-columns: 1fr; } }
        @media print { @page { size: A3; margin: 1cm; } body { background-color: #fff; font-size: 10pt; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .character-sheet { box-shadow: none; border: 1px solid #ccc; max-width: 100%; } .buttons-section, .gear-controls, .remove-row-btn, .select-protective-gear-btn, .clear-protective-gear-btn, .portrait-controls, #king_of_men_bonus, .modal-overlay, .custom-file-upload { display: none; } .traits-container { grid-template-columns: repeat(3, 1fr) !important; } .header-info { display: grid !important; grid-template-columns: repeat(9, 1fr) 3fr !important; grid-template-rows: repeat(8, auto) !important; gap: 15px !important; align-items: start !important; } .header-info .info-item { width: auto !important; } .portrait-box { width: auto !important; order: initial !important; text-align: center; margin-bottom: 0; } input, textarea, select { border: 1px solid #ccc !important; background-color: #fdfdfd !important; -webkit-appearance: none; appearance: none; padding: 8px; color: #000; border-radius: 4px; box-sizing: border-box; width: 100%; } input[readonly], input.readonly { background-color: #eee !important; } select { -webkit-appearance: none; -moz-appearance: none; appearance: none; background-image: none !important; } input[type="checkbox"] { border: 1px solid #000 !important; width: 20px; height: 20px; padding: 0; } .skill-ranks input[type="checkbox"]::before { background-color: #000; } h1, h2, legend { border-color: #ccc; } #portrait_preview { border: 1px solid #ccc !important; } .description-box { min-height: 60px; background: #fff; border: 1px dashed #c8a077 !important; } }
    </style>
</head>
<body>

<div class="character-sheet">
    <h1>魔戒TRPG 人物卡</h1>

    <div class="grid-container">
        <div class="header-info">
            <div class="info-item char-name"><label for="char_name">角色姓名</label><input type="text" id="char_name" name="char_name"></div>
            <div class="info-item heroic-culture">
                <label for="heroic_culture">英雄所属文化</label>
                <select id="heroic_culture" name="heroic_culture">
                    <option value="">--请选择文化--</option>
                    <option value="巴德一族的人类">巴德一族的人类</option>
                    <option value="都林一族的矮人">都林一族的矮人</option>
                    <option value="林顿的精灵">林顿的精灵</option>
                    <option value="夏尔的霍比特人">夏尔的霍比特人</option>
                    <option value="布理的人类">布理的人类</option>
                    <option value="北方的游民">北方的游民</option>
                </select>
            </div>
            <div class="info-item char-age"><label for="char_age">年龄</label><input type="text" id="char_age" name="char_age"></div>
            <div class="info-item char-living-standard"><label for="char_living_standard">生活水平</label><input type="text" id="char_living_standard" name="char_living_standard" class="readonly" readonly></div>
            
            <div class="info-item game-mode">
                <label>游戏模式</label>
                <div class="game-mode-group">
                    <input type="radio" id="mode_normal" name="game_mode" value="20" checked><label for="mode_normal"> 普通</label>
                    <input type="radio" id="mode_simple" name="game_mode" value="18"><label for="mode_simple"> 简单</label>
                </div>
            </div>

            <div class="info-item cultural-blessing">
                <label for="cultural_blessing">文化赐福</label>
                <input type="text" id="cultural_blessing" name="cultural_blessing" class="readonly" readonly>
                <div class="description-box" id="cultural_blessing_desc"></div>
                <div id="king_of_men_bonus" class="hidden">
                    <button type="button" data-stat="body">体魄</button>
                    <button type="button" data-stat="heart">心志</button>
                    <button type="button" data-stat="wits">才智</button>
                    <button type="button" id="reset_king_bonus">重置</button>
                </div>
            </div>
            <div class="info-item calling">
                <label for="calling">呼召</label>
                <select id="calling" name="calling">
                    <option value="">--请选择呼召--</option>
                    <option value="领袖">领袖</option>
                    <option value="勇士">勇士</option>
                    <option value="信使">信使</option>
                    <option value="学者">学者</option>
                    <option value="寻宝客">寻宝客</option>
                    <option value="守望者">守望者</option>
                </select>
            </div>
            <div class="info-item char-treasure"><label for="char_treasure">宝藏</label><input type="text" id="char_treasure" name="char_treasure"></div>
            
            <div class="info-item char-patron"><label for="patron">赞助人</label><input type="text" id="patron" name="patron"></div>
            <div class="info-item flaw"><label for="flaw">缺陷</label><input type="text" id="flaw" name="flaw"></div>

            <div class="info-item shadow-path"><label for="shadow_path">魔影之路</label><input type="text" id="shadow_path" name="shadow_path"></div>
            <div class="info-item status-checks">
                <label>状态</label>
                <div class="status-checkbox-group">
                    <div><input type="checkbox" id="status_weary" name="status_weary"><label for="status_weary"> 疲惫</label></div>
                    <div><input type="checkbox" id="status_miserable" name="status_miserable"><label for="status_miserable"> 痛苦</label></div>
                    <div><input type="checkbox" id="status_wounded" name="status_wounded"><label for="status_wounded"> 重伤</label></div>
                </div>
            </div>
            <div class="info-item wound-severity"><label for="wound_severity">受伤程度</label><input type="text" id="wound_severity" name="wound_severity"></div>

            <div class="info-item adventure-points"><label for="adventure_points">冒险点数</label><input type="number" id="adventure_points" name="adventure_points"></div>
            <div class="info-item skill-points"><label for="skill_points">技能点数</label><input type="number" id="skill_points" name="skill_points"></div>
            <div class="info-item fellowship-points"><label for="fellowship_points">同盟点数</label><input type="number" id="fellowship_points" name="fellowship_points"></div>

            <div class="portrait-box">
                <img id="portrait_preview" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzg4OCIgc3Ryb2tlLXdpZHRoPSIxIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMCAyMWE4IDggMCAwIDAtMTYgME0xMiAxM2E0IDQgMCAxIDAgMC04IDQgNCAwIDAgMCAwIDhaIi8+PC9zdmc+" alt="人物形象预览">
                <div class="portrait-controls">
                    <label for="portrait_upload" class="custom-file-upload">选择文件</label>
                    <input type="file" id="portrait_upload" accept="image/*">
                </div>
            </div>
            
            <div class="secondary-stats-container">
                 <div class="diamond-box diamond-box-small">
                    <div class="diamond-content">
                        <div class="attr-tn"><label for="load_val">负重</label><input type="number" id="load_val" name="load_val" min="0" readonly></div>
                        <div class="attr-val"><label for="fatigue_val">劳顿值</label><input type="number" id="fatigue_val" name="fatigue_val" min="0" value="0"></div>
                        <div class="attr-derived">当前耐力:<input type="number" id="current_endurance" class="current-stat-input-diamond"></div>
                    </div>
                </div>
                <div class="diamond-box diamond-box-small">
                    <div class="diamond-content">
                        <div class="attr-tn"><label for="shadow_val">魔影</label><input type="number" id="shadow_val" name="shadow_val" min="0" value="0"></div>
                        <div class="attr-val"><label for="shadow_scar_val">伤疤</label><input type="number" id="shadow_scar_val" name="shadow_scar_val" min="0" value="0"></div>
                        <div class="attr-derived">当前希望:<input type="number" id="current_hope" class="current-stat-input-diamond"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="personal_traits_section">
            <h2>个人特质</h2>
            <div class="traits-container">
                <div class="trait-box">
                    <label for="trait1_select">文化特质 1</label>
                    <select id="trait1_select" name="trait1_select" disabled>
                        <option value="">--先选择文化--</option>
                    </select>
                    <div class="description-box" id="trait1_desc"></div>
                </div>
                <div class="trait-box">
                    <label for="trait2_select">文化特质 2</label>
                    <select id="trait2_select" name="trait2_select" disabled>
                        <option value="">--先选择文化--</option>
                    </select>
                    <div class="description-box" id="trait2_desc"></div>
                </div>
                <div class="trait-box">
                    <label for="trait3_calling_feature">职业特性</label>
                    <input type="text" id="trait3_calling_feature" name="trait3_calling_feature" class="readonly" readonly>
                    <div class="description-box" id="trait3_desc">由您的职业决定。</div>
                </div>
            </div>
        </div>


        <div class="section-break"></div>

        <div class="attributes-section">
            <div style="grid-column: span 4;">
                <div class="diamond-box">
                    <div class="diamond-content">
                        <div class="attr-title">体魄</div>
                        <div class="attr-tn"><label for="body_tn">TN</label><input type="number" id="body_tn" name="body_tn" min="0" max="20"></div>
                        <div class="attr-val"><label for="body_val">数值</label><input type="number" id="body_val" name="body_val" min="0" max="20" value="0"></div>
                        <div class="attr-derived">耐力上限: <span id="endurance_val">0</span></div>
                    </div>
                </div>
            </div>

            <div style="grid-column: span 4;">
                <div class="diamond-box">
                    <div class="diamond-content">
                        <div class="attr-title">心志</div>
                        <div class="attr-tn"><label for="heart_tn">TN</label><input type="number" id="heart_tn" name="heart_tn" min="0" max="20"></div>
                        <div class="attr-val"><label for="heart_val">数值</label><input type="number" id="heart_val" name="heart_val" min="0" max="20" value="0"></div>
                        <div class="attr-derived">希望上限: <span id="hope_val">0</span></div>
                    </div>
                </div>
            </div>

            <div style="grid-column: span 4;">
                <div class="diamond-box">
                    <div class="diamond-content">
                        <div class="attr-title">才智</div>
                        <div class="attr-tn"><label for="wits_tn">TN</label><input type="number" id="wits_tn" name="wits_tn" min="0" max="20"></div>
                        <div class="attr-val"><label for="wits_val">数值</label><input type="number" id="wits_val" name="wits_val" min="0" max="20" value="0"></div>
                        <div class="attr-derived">招架: <span id="parry_val">0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-break"></div>

        <div class="skills-section">
            <div class="skills-column">
                <h2>体魄技能</h2>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_awe" name="spec_awe"><label for="spec_awe"></label></div><label class="skill-name-label">威慑</label><div class="skill-ranks" id="skill_awe"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_athletics" name="spec_athletics"><label for="spec_athletics"></label></div><label class="skill-name-label">运动</label><div class="skill-ranks" id="skill_athletics"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_awareness" name="spec_awareness"><label for="spec_awareness"></label></div><label class="skill-name-label">觉察</label><div class="skill-ranks" id="skill_awareness"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_hunting" name="spec_hunting"><label for="spec_hunting"></label></div><label class="skill-name-label">狩猎</label><div class="skill-ranks" id="skill_hunting"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_song" name="spec_song"><label for="spec_song"></label></div><label class="skill-name-label">歌唱</label><div class="skill-ranks" id="skill_song"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_craft" name="spec_craft"><label for="spec_craft"></label></div><label class="skill-name-label">手艺</label><div class="skill-ranks" id="skill_craft"></div></div>
            </div>
            <div class="skills-column">
                <h2>心志技能</h2>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_enhearten" name="spec_enhearten"><label for="spec_enhearten"></label></div><label class="skill-name-label">鼓舞</label><div class="skill-ranks" id="skill_enhearten"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_travel" name="spec_travel"><label for="spec_travel"></label></div><label class="skill-name-label">旅行</label><div class="skill-ranks" id="skill_travel"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_insight" name="spec_insight"><label for="spec_insight"></label></div><label class="skill-name-label">洞悉</label><div class="skill-ranks" id="skill_insight"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_healing" name="spec_healing"><label for="spec_healing"></label></div><label class="skill-name-label">医疗</label><div class="skill-ranks" id="skill_healing"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_courtesy" name="spec_courtesy"><label for="spec_courtesy"></label></div><label class="skill-name-label">礼仪</label><div class="skill-ranks" id="skill_courtesy"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_battle" name="spec_battle"><label for="spec_battle"></label></div><label class="skill-name-label">作战</label><div class="skill-ranks" id="skill_battle"></div></div>
            </div>
            <div class="skills-column">
                <h2>才智技能</h2>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_persuade" name="spec_persuade"><label for="spec_persuade"></label></div><label class="skill-name-label">说服</label><div class="skill-ranks" id="skill_persuade"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_stealth" name="spec_stealth"><label for="spec_stealth"></label></div><label class="skill-name-label">潜行</label><div class="skill-ranks" id="skill_stealth"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_search" name="spec_search"><label for="spec_search"></label></div><label class="skill-name-label">搜索</label><div class="skill-ranks" id="skill_search"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_explore" name="spec_explore"><label for="spec_explore"></label></div><label class="skill-name-label">探索</label><div class="skill-ranks" id="skill_explore"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_riddle" name="spec_riddle"><label for="spec_riddle"></label></div><label class="skill-name-label">暗语</label><div class="skill-ranks" id="skill_riddle"></div></div>
                <div class="skill-item"><div class="specialization-container"><input type="checkbox" id="spec_lore" name="spec_lore"><label for="spec_lore"></label></div><label class="skill-name-label">学识</label><div class="skill-ranks" id="skill_lore"></div></div>
            </div>
        </div>

        <div class="section-break"></div>

        <div class="combat-features-section">
            <div class="combat-proficiencies">
                <h2>战斗熟练</h2>
                <div class="skill-item"><label>斧</label><div class="skill-ranks" id="prof_axes"></div></div>
                <div class="skill-item"><label>弓</label><div class="skill-ranks" id="prof_bows"></div></div>
                <div class="skill-item"><label>矛</label><div class="skill-ranks" id="prof_spears"></div></div>
                <div class="skill-item"><label>剑</label><div class="skill-ranks" id="prof_swords"></div></div>
            </div>

            <div class="feature-box">
                <h2>英勇与勋绩</h2>
                <div class="info-item">
                    <label for="valour">英勇</label>
                    <input type="number" id="valour" name="valour" min="0" value="0">
                </div>
                <div id="rewards_container">
                </div>
            </div>

            <div class="feature-box">
                <h2>智慧与美德</h2>
                <div class="info-item"><label for="wisdom">智慧</label><input type="number" id="wisdom" name="wisdom" value="0"></div>
                <div id="virtues_container">
                </div>
            </div>
        </div>


        <div class="section-break"></div>

        <div class="gear-section">
            <div class="gear-table">
                <h2>作战装备</h2>
                <table>
                    <thead><tr><th>作战装备</th><th>伤害值</th><th>攻伤值</th><th>负重</th><th>备注</th><th>操作</th></tr></thead>
                    <tbody id="combat_gear_body"></tbody>
                </table>
                <div class="gear-controls">
                    <button type="button" id="add_combat_gear_btn">+ 添加一行</button>
                </div>
            </div>
            <div class="gear-table" style="margin-top: 20px;">
                <h2>防护装备</h2>
                <table>
                    <thead><tr><th>护甲/头盔/盾牌</th><th>防护值</th><th>负重</th><th>类型</th><th>操作</th></tr></thead>
                    <tbody id="protective_gear_body">
                        <tr id="armor_slot">
                            <td><input type="text" data-key="name" readonly placeholder="护甲..."></td>
                            <td><input type="text" data-key="value" class="short-input" readonly></td>
                            <td><input type="number" data-key="load" class="short-input" readonly></td>
                            <td><input type="text" data-key="notes" readonly></td>
                            <td>
                                <button type="button" class="select-protective-gear-btn" data-slot="armor">选择</button>
                                <button type="button" class="clear-protective-gear-btn" data-slot="armor">清除</button>
                            </td>
                        </tr>
                        <tr id="helmet_slot">
                            <td><input type="text" data-key="name" readonly placeholder="头盔..."></td>
                            <td><input type="text" data-key="value" class="short-input" readonly></td>
                            <td><input type="number" data-key="load" class="short-input" readonly></td>
                            <td><input type="text" data-key="notes" readonly></td>
                            <td>
                                <button type="button" class="select-protective-gear-btn" data-slot="helmet">选择</button>
                                <button type="button" class="clear-protective-gear-btn" data-slot="helmet">清除</button>
                            </td>
                        </tr>
                        <tr id="shield_slot">
                            <td><input type="text" data-key="name" readonly placeholder="盾牌..."></td>
                            <td><input type="text" data-key="value" class="short-input" readonly></td>
                            <td><input type="number" data-key="load" class="short-input" readonly></td>
                            <td><input type="text" data-key="notes" readonly></td>
                            <td>
                                <button type="button" class="select-protective-gear-btn" data-slot="shield">选择</button>
                                <button type="button" class="clear-protective-gear-btn" data-slot="shield">清除</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="info-item" style="grid-column: span 12; margin-top: 20px;">
                <label for="travel_gear"><h2>旅行装备</h2></label>
                <textarea id="travel_gear" name="travel_gear" rows="4"></textarea>
            </div>
        </div>

        <div class="buttons-section">
            <button id="save-btn">保存到浏览器</button>
            <button id="export-btn">导出为PDF/打印</button>
            <button id="load-btn">从浏览器读取</button>
            <button id="reset-btn">重置人物卡</button>
        </div>

    </div>
</div>

<div id="combatGearModal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>添加作战装备</h2>
        <form id="combatGearForm">
            <div class="modal-form-item">
                <label for="modal_combat_preset">选择预设装备</label>
                <select id="modal_combat_preset">
                    <option value="">--自定义或选择一项--</option>
                </select>
            </div>
            <hr>
            <div class="modal-form-item">
                <label for="modal_combat_name">作战装备</label>
                <input type="text" id="modal_combat_name" required>
            </div>
            <div class="modal-form-item">
                <label for="modal_combat_damage">伤害值</label>
                <input type="text" id="modal_combat_damage">
            </div>
            <div class="modal-form-item">
                <label for="modal_combat_injury">攻伤值</label>
                <input type="text" id="modal_combat_injury">
            </div>
            <div class="modal-form-item">
                <label for="modal_combat_load">负重</label>
                <input type="number" id="modal_combat_load">
            </div>
            <div class="modal-form-item">
                <label for="modal_combat_notes">备注</label>
                <input type="text" id="modal_combat_notes">
            </div>
            <div class="modal-buttons">
                <button type="submit">保存</button>
                <button type="button" id="cancel_combat_gear_btn">取消</button>
            </div>
        </form>
    </div>
</div>

<div id="protectiveGearModal" class="modal-overlay hidden">
    <div class="modal-content">
        <h2>添加防护装备</h2>
        <form id="protectiveGearForm">
            <div class="modal-form-item">
                <label for="modal_protective_preset">选择预设装备</label>
                <select id="modal_protective_preset">
                    <option value="">--自定义或选择一项--</option>
                </select>
            </div>
            <hr>
            <div class="modal-form-item">
                <label for="modal_protective_name">护甲/头盔/盾牌</label>
                <input type="text" id="modal_protective_name" required>
            </div>
            <div class="modal-form-item">
                <label for="modal_protective_value">防护值</label>
                <input type="text" id="modal_protective_value">
            </div>
            <div class="modal-form-item">
                <label for="modal_protective_load">负重</label>
                <input type="number" id="modal_protective_load">
            </div>
            <div class="modal-form-item">
                <label for="modal_protective_notes">类型</label>
                <input type="text" id="modal_protective_notes">
            </div>
            <div class="modal-buttons">
                <button type="submit">保存</button>
                <button type="button" id="cancel_protective_gear_btn">取消</button>
            </div>
        </form>
    </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- STATE ---
    let kingOfMenBonusAppliedTo = null;
    let currentProtectiveSlot = null;
    let baseTN = 20; // MODIFIED: Added baseTN for game mode

    // --- ELEMENTS ---
    const bodyVal = document.getElementById('body_val'),
          bodyTN = document.getElementById('body_tn'),
          heartVal = document.getElementById('heart_val'),
          heartTN = document.getElementById('heart_tn'),
          witsVal = document.getElementById('wits_val'),
          witsTN = document.getElementById('wits_tn'),
          enduranceVal = document.getElementById('endurance_val'),
          hopeVal = document.getElementById('hope_val'),
          parryVal = document.getElementById('parry_val'),
          heroicCultureSelect = document.getElementById('heroic_culture'),
          culturalBlessingInput = document.getElementById('cultural_blessing'),
          culturalBlessingDesc = document.getElementById('cultural_blessing_desc'),
          callingSelect = document.getElementById('calling'),
          trait1Select = document.getElementById('trait1_select'),
          trait1Desc = document.getElementById('trait1_desc'),
          trait2Select = document.getElementById('trait2_select'),
          trait2Desc = document.getElementById('trait2_desc'),
          trait3Feature = document.getElementById('trait3_calling_feature'),
          trait3Desc = document.getElementById('trait3_desc'),
          valourInput = document.getElementById('valour'),
          rewardsContainer = document.getElementById('rewards_container');

    // Combat Gear Modal Elements
    const combatGearModal = document.getElementById('combatGearModal'),
          combatGearForm = document.getElementById('combatGearForm'),
          cancelCombatGearBtn = document.getElementById('cancel_combat_gear_btn'),
          combatPresetSelect = document.getElementById('modal_combat_preset');

    // Protective Gear Modal Elements
    const protectiveGearModal = document.getElementById('protectiveGearModal'),
          protectiveGearForm = document.getElementById('protectiveGearForm'),
          cancelProtectiveGearBtn = document.getElementById('cancel_protective_gear_btn'),
          protectivePresetSelect = document.getElementById('modal_protective_preset');


    // --- DATA MAPPINGS ---
    const traitsData = { '大胆': '你对自己的能力极为自信，因此你并不容易被吓倒，并且随时准备好投身于危险。', '狡黠': '你的才思敏锐，每当有机会你都会利用它为自己取得优势。', '热忱': '每当某项活动激起你的兴趣，你都会非常激动且迫不及E待。', '忠贞': '你坚定不渝地献身于你选择的理想或追随之人，你的事功往往也有赖这份忠诚坚贞。', '迷人': '在大多数人眼中，你都显得魅力十足，即便他们并非与你同族同类。', '言语得体': '你的言谈举止令人如沐春风而又不失礼数，因此你的话语鲜少引来敌意。', '凶狠': '在你被激怒时，或者在你认为有必要的时候，你会显露出你野蛮凶狠的一面。', '慷慨': '你在物质和真心上都不吝于给予，总是把他人的需求放在心上。', '正直': '你坚信人应当公正行事，也应当遵循道德做正确的事。', '好奇': '你天性好奇，即使与自己无关的事物也能轻易激起你的兴趣。这种天性的优点在于，你不那么容易被表面现象所蒙蔽。', '目光敏锐': '你的视力比大多数人都敏锐。', '威严': '你的举止中有一种高傲凛然的风度，令旁观者肃然起敬。', '乐天': '你乐观的精神百折不挠，即使在阴影重重之中，你也能发现一丝光明。', '耐心': '你性情平和，不容易发脾气。无论对于蠢人还是事情的延误，还是在面对极为艰苦的处境时，你都可以默默忍受。', '自傲': '你对自己或所属族群的功绩与成就感到深深的骄傲与自豪。', '朴实': '你的行事风格质朴无华，或许有人会觉得略显粗犷，但你深知，真正的金子未必光芒四射，外表也并不能代表一切。', '内敛': '你并不轻易吐露心声，更喜欢将自己的意图隐藏起来不让他人窥视，尤其是对于你的族群之外的人。', '严肃': '你天生严肃而不苟言笑，你的举止、肢体语言和话语之中也时刻体现着这一点。', '机智': '你或许不是一位巫师，但你达成目标的方式往往称得上狡猾，甚至或许可以说是奸诈。', '矫捷': '你的脚步轻快迅速，而且行动果断。', '高大': '你的身材比大多数同族都要高大。', '真诚': '你为人诚恳，往往在言行举止间都显露出你最真挚的想法意图。', '警惕': '你总是对周围环境保持警觉，并且对于不熟悉的人的言行举-止尤为细心注意。', '固执': '你的性情与信念都坚定不移，并且通常只依据自己的判断行事。' };
    const cultureData = { "巴德一族的人类": { blessing: { name: "勇敢刚毅", description: "你的英勇检定都将具备优势。" }, livingStandard: "富有", modifiers: { endurance: 20, hope: 8, parry: 12 }, traits: ['大胆', '热忱', '迷人', '凶狠', '慷慨', '自傲', '高大', '固执']}, "都林一族的矮人": { blessing: { name: "锐不可当", description: "你所穿戴的护甲负重值减半计算（往上取整），包括头盔（但不包括盾牌）。" }, livingStandard: "富有", modifiers: { endurance: 22, hope: 8, parry: 10 }, traits: ['狡黠', '凶狠', '威严', '自傲', '内敛', '严肃', '警惕', '固执']}, "林顿的精灵": { blessing: { name: "精灵之艺", description: "*如果你不处于痛苦状态，当你使用至少拥有1个等级的技能时，你可以通过消耗1点希望值从而在该技能检定中取得魔法成功。" }, livingStandard: "节俭", modifiers: { endurance: 20, hope: 8, parry: 12 }, traits: ['迷人', '目光敏锐', '威严', '乐天', '耐心', '机智', '矫捷', '警惕']}, "夏尔的霍比特人": { blessing: { name: "见怪不怪", description: "*你的智慧检定视为优势，并且你在有关抵御贪婪影响的魔影检定中获得（1d）。" }, livingStandard: "普通", modifiers: { endurance: 18, hope: 10, parry: 12 }, traits: ['热忱', '言语得体', '忠贞', '正直', '好奇', '目光敏锐', '乐天', '朴实']}, "布理的人类": { blessing: { name: "布理血脉", description: "*玩家团队中每有一名布理人，同盟点就会提升1点。" }, livingStandard: "普通", modifiers: { endurance: 20, hope: 10, parry: 10 }, traits: ['狡黠', '言语得体', '忠贞', '慷慨', '好奇', '耐心', '朴实', '真诚']}, "北方的游民": { blessing: { name: "人中王者", description: "*任选一项属性提升1点。" }, livingStandard: "节俭", modifiers: { endurance: 20, hope: 6, parry: 14 }, traits: ['大胆', '正直', '内敛', '严肃', '机智', '矫捷', '高大', '真诚']}, "": { blessing: { name: "", description: ""}, livingStandard: "", modifiers: { endurance: 0, hope: 0, parry: 0 }, traits: []} };
    const callingFeatures = { '领袖': { name: '领导力', description: '你拥有引领他人行动的能力。在面对压力时，其他人会自然而然地向你寻求指导。'}, '勇士': { name: '宿敌知识', description: '宿敌知识并不是一种单独的特质；你必须选择其适用的敌人种类。你可以从邪恶人类、奥克、蜘蛛、食人妖、座狼和亡灵中进行选择。这种额外特质可让你了解所选敌人的特点、习性、优势与弱点。'}, '信使': { name: '民间知识', description: '四处游历让你对自由之民所组成的各个社区的许多传统习俗、信仰和故事略知一二。在你与陌生人打交道时，这些信息可能会有所帮助，让你能够刚巧知道一些与他们民俗相关的事实，或者恰好掌握了一部分对方的语言。'}, '学者': { name: '学识诗歌', description: '许多文化都曾创作过一种名为学识诗歌的短诗，用以铭记那些重要历史事件，以免它们湮没于岁月的长河中。中洲的学者们认为，他们之所以能了解诸多古代知识，很大程度上要归功于这些诗歌。'}, '寻宝客': { name: '盗窃', description: '这项令人敬畏的技艺包含了扒窃、开锁，以及总的来说，任何能够偷偷摸摸获取他人财产或进入看守区域的手段。'}, '守望者': { name: '魔影知识', description: '你已经察觉到，在中洲世界中，大多数邪恶、黑暗和可怖之事背后似乎有一条隐秘的脉络，而这份隐秘勾连更是日渐滋长。这是中洲土地上智者的共识，而这份知识背后的真相也终将水落出。'}, '': { name: '', description: '由您的职业决定。' }};
    const rewardsData = { "贴身": "技艺高超的铁匠把这件防具打造得更为坚固，难以被致命一击穿透。\n当你穿戴着贴身的护甲或头盔时，你的防护检定结果+2。", "精工": "熟练的工匠将这件装备打造得更加轻盈、灵活。\n所选物品的负重值减少2（最小负重为0）。", "致命": "这利器所使出的一击，既迅猛又精准，更难被护甲阻挡。\n所选武器的致伤值增加2。\n可以被单手和双手使用的武器，两方的致伤值都会获得提升。", "深化": "这件武器强劲而沉重，能够对目标造成更多伤害。\n所选武器的伤害值增加1。", "利刃": "这件武器十分锋利或者平衡性更好，它在命中目标时有更大可能性造成致命一击。\n使用利刃武器攻击时，技艺骰结果为9的时候也会造成致命一击。", "加固": "这面盾牌的结构得到了加固，它可能在边缘被金属加固，或者有一个更大的铁制凸起，让使用者可以更容易地招架攻击。\n盾牌的招架值增加1", "": "" };

    // 通用美德数据
    const generalVirtuesData = {
        "自信": "克服重重难关，不仅砥砺了你的意志，更让你重新树立了对美好未来的信心。\n\n你的希望上限提升2点。",
        "坚毅": "你的每一次挥击愈发强劲，每一次瞄准也更为精准，这让你能够造成更大的伤害。\n\n? 当你在战斗中成功进行特殊攻击时，你选择重击时则视作体魄值+1，你选择穿刺时则视作技艺骰结果数值+1。",
        "顽强": "你的决心和毅力在艰难困苦中获得了锻炼。\n\n你的最大耐力值提高2点，或根据你的智慧等级来提升最大耐力值，以高者为准。",
        "精通": "你反复练习某些技能，直到它们变得易如反掌。\n\n选择两种技能，使其成为专精技能。",
        "机敏": "你在战斗中的技巧（或运气？）随着你的智慧越发成熟而与日俱增。\n\n你的招架值提高1点。",
        "巧技": "冒险磨炼了你与生俱来的才能。\n\n你的一项属性目标值降低1点。"
    };

    // 种族特定美德数据
    const cultureSpecificVirtuesData = {
        "巴德一族的人类": {
            "制作克拉姆": "你学会了制作一种名为克拉姆的古老食品，这是一种类似饼干、但几乎可以无限期保存的糕点，由你们族人为了长途旅行而发明。尽管它不怎么好吃（实际上，可说食之无味），但它无疑能提供持久的能量，而且营养丰富。\n每当你在旅行事件中获得劳顿值时，你所获得的劳顿值会减少1点。\n此外，当你进行短休时，你和所有团队成员将额外恢复等同于你智慧等级的耐力损失。",
            "屠龙者": "弓箭手巴德的传奇故事激励了河谷城的许多年轻男女，使许多人也开始渴望通过亲手屠杀一头巨兽来证明自己。你也跟之前的许多人一样，经常冥思苦想如何对付各种大型生物，希望有朝一日你也能战胜它们，扬名立万。\n当你与力量为2及以上的生物战斗时，你所有的攻击检定都会获得优势。",
            "矮人之友": "在与巨龙抗争的岁月中，巴德一族与埃瑞博的矮人缔结了坚实的联盟。\n如果你的同盟焦点为一名矮人，采取防御姿态进行战斗的你或你的同盟焦点都能以次要行动执行战斗动作：保护同伴，以另一方为目标。\n此外，在会议的交流阶段，矮人总是视为对你持友好态度。",
            "箭无虚发": "黑箭能够击落巨龙斯毛格也许是命运的安排，但射出那惊雷般的一击的手臂却无疑蕴含着惊人的力量。在你投掷长矛或拉满弓弦之际，你总能确保自己的手又稳又准，确实无疑地命中要害。\n当你在远程攻击中造成致命一击时，目标的防御检定将为劣势检定。\n会议或旅行一次，你都可以选择在任何单次检定中获得激励。"
        },
        "都林一族的矮人": {
            "矮人的战斧啊！": "尽管矮人族的秘密语言犹如远古奇珍而从不外传，但他们的战吼却声名远扬，令他们的宿敌闻风丧胆。\n每次战斗中一次，当你以奋进姿态战斗时，你可以使你的攻击检定成为优势检定，并以次要行动尝试威吓敌人。",
            "破碎咒语": "古代矮人曾创造过强大的法术。你已习得一些古老魔法的残篇，它们至今仍留存着部分力量。\n选择你三项至少拥有1个等级的技能，并在你的角色卡上用一个点（或者符文！）作出相应的标记。每当你使用这三个已标记的技能之一时，你都可以消耗1点希望以获得魔法成功。",
            "暗中行事": "你的族群并不像大多数其他文化那样困扰于黑暗。相反，你的成长环境让你喜欢黑暗胜过光明，在它冰冷的怀抱中感到自在。\n当你处于黑暗中（在晚上或地下时），你的所有检定都获得激励。",
            "都林之道": "矮人们在地底深处经历过无数战争。你学习过在地底战斗中实现最佳防守的技巧。因此，你深谙如何利用角落、黑暗以及其他自然障碍取得优势\n在地下或其他如建筑物内的狭窄空间进行战斗时，你的招架值+2。",
            "坚如磐石": "矮人天生强壮而坚韧，因为他们来到这个世界时，某个巨大的邪恶正统治着中洲世界。只要你的精神还在支撑肉体，你就比大多数人更能抵抗任何身体伤害。\n你的最大耐力值提升1点。只要你未处于痛苦状态，你的所有防护检定都将获得优势。",
            "不屈灵魂": "矮人一族自诞生之初就被赋予抵抗各种控制的能力。你的心志坚定不移，能挡下大敌的各种武器和攻击，只除了最为难以察觉的那些。\n使你的希望上限提升1点。你在进行抵御巫术效果的魔影检定时，将获得（1d）的奖励。"
        },
        "林顿的精灵": {
            "不惧亡魂": "尽管一般情况下活人看不见幽界中的各种恶灵鬼魂，只能听到它们令人胆寒的低语哀叹，精灵却能清楚感知到它们。你懂得如何坚定心志，抵抗这类恐怖的影响。\n你对恐惧引起的所有魔影检定都将获得优势，如果是恶灵或鬼魂（包括被其附身的生物）迫使你进行检定，你还将额外获得（1d）的奖励。",
            "百步穿杨": "精灵天生便擅长使用弓箭，而你更是将此天赋发挥得淋漓尽致，你的箭矢总能以不可思议的精准度命中目标。\n当你使用弓（只要不是大弓）并以后卫姿态战斗时，你就能以次要行动瞄准动作。",
            "埃尔贝瑞丝！吉尔松涅尔！": "所有仍居住在中洲的埃尔达都尊崇星辰之后埃尔贝瑞丝的名字。你在陷入危难的时候呼唤她的名字，并请求点燃星辰者赐予你她的恩典。\n使你的希望上限提升1点。在冒险阶段，你可以在检定中获得激励，次数等于你的智慧等级。",
            "精灵梦境": "精灵族拥有异常强大的精神力，这使得他们的身躯能够抵御众多疾病与创伤，并以惊人的速度恢复健康。随着你的智慧等级提升，你休息与恢复所需的睡眠越来越少。取而代之的是，你学会了族人独有的秘技，能够在清醒状态下的操练中迅速消除疲劳。\n你不需要睡觉，只要你能够沉浸于一些简单、重复的活动。当你短休时，你被视作进行了长休。",
            "怒火闪烁": "在与魔影的战争中，你的族人历经无数失败，也取得过许多无果的胜利。也正是你们一族对大敌的深刻憎恨与无尽怒火，在你的武器中灌注了一道炽烈的冷焰。\n在成功的攻击检定中，你的对手额外失去一点仇恨或士气，每掷出一个成功标记【精灵字符】再额外增加一点。",
            "旧时之忆": "漫长世纪的流转与无数人类世代的更迭，对于精灵而言也仿佛只是短短的片刻。你的记忆深邃而辽远，能够回溯至埃利阿多尚且繁荣的古老年代。如今，随着你再次踏上这片熟悉而又陌生的土地，关于它的记忆与知识又在你的脑海中逐渐苏醒。\n当你身处于荒野之地并成为某个旅行事件的目标时，你在旅行事件表上的检定结果将如同你身处边陲之地那样；当你身处于黑暗之地并成为某个旅行事件的目标时，你在旅行事件表上的检定结果将如同你身处荒野之地那样。此外，除了你所选择的旅行职责之外，你还可以额外担任斥候的职责"
        },
        "夏尔的霍比特人": {
            "销声匿迹": "据传，霍比特人几乎不具备魔法能力，但他们在自己愿意的时候迅速且无声地消失无踪的能力，对于其他人而言只能用不可思议来形容。你已经掌握了这门技艺，知道如何准确把握时机、从他人的注意中消失，有时候甚至不需要你自己意识到有躲起来的必要。\n如果某个地点或情形提供了哪怕是最微小的隐藏或悄然离开的机会，你都可以进行潜行检定：若你成功通过该检定，你可以直接消失。\n如果有人看向你的位置，你就像是人间蒸发一般消失无踪。你可以选择在任何时候现身，只要从你的藏身处走出来即可。",
            "绝境之勇": "智者中的一位曾说到，唯有将霍比特人置于困境之中，方能洞察其内心所蕴藏的品质。你虽宁愿避免陷入如此绝境，但也深信自己能在这些情境中全身而退。\n当你处于痛苦、疲惫或重伤状态时，你的所有检定受到激励。",
            "小家伙": "霍比特人身材矮小，但他们人短智不短。你深谙如何利用自己小巧的身材在战斗中占据优势。\n当你近身战斗的对象比你高大时（这时常发生！），你的招架等级增加2。此外，只需一名队友采取近身战斗的姿态，你就可以在战斗中采取后卫姿态。",
            "精确瞄准": "霍比特人身手敏捷且目光锐利，这些特质使他们成为出色的射手。你已将这份天赋锤炼至炉火纯青，随手拾起一块石头，也能成为致命武器。\n你所有的远程攻击都有优势。若你以投掷石块的方式发起攻击，你会在结果为【甘道夫徽记】时造成致命一击，其致伤值为12。",
            "三人为伴": "智者曾言，友谊的力量有时能胜过无上的智慧。这一点在霍比特人身上体现得尤为淋漓尽致，因为众所周知，霍比特人与朋友之间的羁绊之深，几乎无法被任何力量所割裂。你深信你的队友们，这种紧密的信任之纽带让真挚的友谊在你们之间生根发芽、茁壮成长。\n你团队的同盟点上限提高1点。此外，你可以选择第二个同盟焦点。",
            "坚韧如老树根": "大家都说霍比特人吓不倒、杀不死，只要稍微休息片刻，他们就能以惊人的速度复原。你发现自己能从摔伤和擦伤中飞速恢复（尽管伴随着剧烈的疼痛）。\n当你身受重伤且必须通过检定来确定伤势的严重程度时，你可以投掷两个技艺骰而非一个，并取其中较好的结果。此外，在休息期间恢复耐力时，将以你的体魄值的两倍来计算。"
        },
        "布理的人类": {
            "布理小马": "布理小马与其主人布理人十分相像——与其他中洲地区的同类相比，它们似乎并无特别突出之处，但它们之中的一些个体却展现出非凡的勇气和卓越的记忆力。你获得了一匹异常勇敢且聪明的小马，它会追随你到天涯海角。\n使你的希望上限提升1点。此外，无论你的生活水平如何，你的小马都拥有4点的活力。\n你的小马与你形影不离。若你不得已要与它分开，例如进入地下通道时，你可以选择要它留在当地，或是让它败，如今只有废墟仍标记着它们的边界。然而，布理人却在这当中存续了下来，展现出出人意表的坚韧与生命力。\n使你的耐力上限提升1点。在每个战斗场景结束时，如果你未处于重伤或痛苦状态，你将恢复等同于你的心志值或英勇等级的耐力。",
            "血气方刚": "你这辈子都在荒野边缘生活，但在你所经历的岁月中，布理所面临的最大威胁也不过是强盗的侵扰和饥饿狼群的游荡。如今面对来自东方的魔影，你虽不清楚自己这样的普通人能够如何与之抗衡，但你心中坚信，无论需要付出怎样的代价，你都将毫不退缩、与之抗争到底。\n当你在某次检定中选择消耗希望点时，你可以选择同时获得1点魔影点以使该次检定获得激励效果。",
            "友好亲切": "自从踏上冒险之旅，你越来越领悟到，你的族人与陌生人贸易的传统或许能在你的旅途中发挥重要作用。你以礼貌友好的态度待人接物，总能轻易赢得陌生人的好感与信任；同时你也能既保持好奇心又不失分寸，从而从陌生人那里问出许多信息，这使得你能够抓住许多宝贵机会向沿途遇见的各色人等学习。\n你在会议阶段中可尝试的技能检定次数上限额外增加1次。此外，你遇到的人总是视作对你持友好态度。",
            "稀奇好比布理奇闻": "的确，布理人主要关心的是四个村庄的事务，但那些最好奇的居民总是热衷于收集来自远方的消息。你早已学到，倾听旅人们讲述的各种奇闻轶事有时价值连城。\n在每个同盟阶段，你都会从博闻者那里得知一则流言。此外，如果你在布理地区，你的所有洞悉和暗语检定都会获得（1d）。",
            "吞云吐雾": "你深谙吞吐之道，总是随身携带烟斗与一大袋烟斗草，毕竟吸上一口烟，清明似神仙。\n无论是在冒险阶段还是同盟阶段，当你恢复1点及以上的希望时，你都能额外恢复1点希望。"
        },
        "北方的游民": {
            "游民之韧": "俗话说，只要有踪迹，游民追不腻。你衷心希望这句古训能够应验，因为你的命运注定了你将时常匆忙踏上旅途，不论是为了紧急的送信任务而奔赴遥远他乡，还是永无止境地追猎你的种种宿敌。\n你的耐力上限提升1点。如果你身穿皮甲（没有戴头盔）或没有着甲，且未携带盾牌，你在旅行中将不会获得劳顿点数。",
            "远见卓识": "北方的游民虽然已不如其祖先那般拥普通你曾亲耳听到逝者在孤寂墓穴中的凄凉私语，你也曾亲眼目睹鬼火在鬼影幢幢的山丘上舞动、闪烁。然而，当你的内心有了坚定的意志，世间便罕有事物能动摇你的心志。\n你在所有抵御恐惧影响的魔影检定中获得（1d）的奖励。",
            "荒野之道": "北方的游民们不停地四处穿梭，猎捕着那些邪恶的生物，坚定地守护着每一条边境线。你们熟知荒野的每一寸土地，正如霍比特人熟悉自己家乡的道路，而这片广袤的土地本身也会向你透露新的流言。\n每当你进行探索、狩猎或旅行检定时，你都可以消耗1点希望来获得魔法成功。此外在旅行阶段中，你总是可以担任多个团队角色。"
        }
    };

    const combatGearPresets = [
        { name: '徒手攻击', damage: '1', injury: '—', load: '0', proficiency: '格斗 *', notes: '包括投掷石块。无法造成致命一击。' },
        { name: '匕首', damage: '2', injury: '14', load: '0', proficiency: '格斗 *', notes: '可以如同剑鞘般发射 (详见于第99页)' },
        { name: '短棍', damage: '3', injury: '12', load: '0', proficiency: '格斗 *', notes: '—' },
        { name: '棍棒', damage: '4', injury: '14', load: '1', proficiency: '格斗 *', notes: '—' },
        { name: '短剑', damage: '3', injury: '16', load: '1', proficiency: '剑类', notes: '—' },
        { name: '剑', damage: '4', injury: '16', load: '2', proficiency: '剑类', notes: '—' },
        { name: '长剑', damage: '5', injury: '16 (单手) / 18 (双手)', load: '3', proficiency: '剑类', notes: '可单手或双手持握' },
        { name: '短矛', damage: '3', injury: '14', load: '2', proficiency: '矛类', notes: '可投掷' },
        { name: '矛', damage: '4', injury: '14 (单手) / 16 (双手)', load: '3', proficiency: '矛类', notes: '可单手或双手持握' },
        { name: '巨矛', damage: '5', injury: '16', load: '4', proficiency: '矛类', notes: '双手持握' },
        { name: '斧', damage: '5', injury: '18', load: '2', proficiency: '斧类', notes: '—' },
        { name: '长柄斧', damage: '6', injury: '18 (单手) / 20 (双手)', load: '3', proficiency: '斧类', notes: '可单手或双手持握' },
        { name: '巨斧', damage: '7', injury: '20', load: '4', proficiency: '斧类', notes: '双手持握' },
        { name: '鹤嘴锄', damage: '7', injury: '18', load: '3', proficiency: '斧类', notes: '双手持握' },
        { name: '弓', damage: '3', injury: '14', load: '2', proficiency: '弓类', notes: '远程武器，双手持握' },
        { name: '大弓', damage: '4', injury: '16', load: '4', proficiency: '弓类', notes: '远程武器，双手持握' }
    ];

    const protectiveGearPresets = [
        { name: '皮革衣', value: '1d', load: '3', type: '皮甲' },
        { name: '皮革甲', value: '2d', load: '6', type: '皮甲' },
        { name: '链甲衫 **', value: '3d', load: '9', type: '链甲' },
        { name: '链甲衣 **', value: '4d', load: '12', type: '链甲' },
        { name: '头盔 *', value: '+1d', load: '4', type: '头部装备' },
        { name: '盾牌', value: '1d', load: '4', type: '盾牌' }
    ];

    // --- HELPER FUNCTIONS ---
    function handleRankClick(event) {
        const checkbox = event.target;
        if (checkbox.type !== 'checkbox') return;
        if (event.shiftKey) return;
        const checkboxes = Array.from(checkbox.parentNode.children);
        const currentIndex = checkboxes.indexOf(checkbox);
        const isChecking = checkbox.checked;
        for (let i = 0; i < checkboxes.length; i++) {
            if (isChecking) { if (i <= currentIndex) checkboxes[i].checked = true; }
            else { if (i >= currentIndex) checkboxes[i].checked = false; }
        }
    }
    function createRankCheckboxes(containerId, count = 5) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.name = `${containerId}_rank`;
            checkbox.value = i;
            container.appendChild(checkbox);
        }
        container.addEventListener('click', handleRankClick);
    }
    // MODIFIED: Function to handle game mode change
    function handleModeChange() {
        const selectedMode = document.querySelector('input[name="game_mode"]:checked');
        baseTN = selectedMode ? parseInt(selectedMode.value) : 20;
        updateAttributes();
    }
    // MODIFIED: updated to use baseTN
    function updateAttributes() {
        const bVal = parseInt(bodyVal.value) || 0;
        if (document.activeElement !== bodyTN) bodyTN.value = baseTN - bVal;
        const hVal = parseInt(heartVal.value) || 0;
        if (document.activeElement !== heartTN) heartTN.value = baseTN - hVal;
        const wVal = parseInt(witsVal.value) || 0;
        if (document.activeElement !== witsTN) witsTN.value = baseTN - wVal;
        const selectedCulture = heroicCultureSelect.value;
        const modifiers = cultureData[selectedCulture]?.modifiers || cultureData[""].modifiers;
        const enduranceMax = bVal + modifiers.endurance;
        const hopeMax = hVal + modifiers.hope;
        enduranceVal.textContent = enduranceMax;
        hopeVal.textContent = hopeMax;
        parryVal.textContent = wVal + modifiers.parry;

        const currentEnduranceInput = document.getElementById('current_endurance');
        if(currentEnduranceInput.value === '' || currentEnduranceInput.value === '0') currentEnduranceInput.value = enduranceMax;
        const currentHopeInput = document.getElementById('current_hope');
        if(currentHopeInput.value === '' || currentHopeInput.value === '0') currentHopeInput.value = hopeMax;
    }
    // MODIFIED: updated to use baseTN
    function updateFromTN(sourceTN, targetVal) {
        const tnVal = parseInt(sourceTN.value) || 0;
        targetVal.value = baseTN - tnVal;
        updateAttributes();
    }
    function populateTraitSelectors(traitList) {
        [trait1Select, trait2Select].forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">--请选择特质--</option>';
            traitList.forEach(trait => {
                const option = document.createElement('option');
                option.value = trait;
                option.textContent = trait;
                select.appendChild(option);
            });
            select.value = traitList.includes(currentValue) ? currentValue : '';
            select.disabled = traitList.length === 0;
        });
        updateTraitDescriptionsAndDuplicates();
    }
    function updateTraitDescriptionsAndDuplicates() {
        trait1Desc.textContent = traitsData[trait1Select.value] || '';
        trait2Desc.textContent = traitsData[trait2Select.value] || '';
        const val1 = trait1Select.value;
        const val2 = trait2Select.value;
        for (const option of trait2Select.options) { option.disabled = (option.value !== '' && option.value === val1); }
        for (const option of trait1Select.options) { option.disabled = (option.value !== '' && option.value === val2); }
    }
    
    // --- NEW: TOTAL LOAD CALCULATION ---
    function updateTotalLoad() {
        let totalLoad = 0;
        const isDwarf = heroicCultureSelect.value === '都林一族的矮人';

        // 1. 计算所有战斗装备的负重
        document.querySelectorAll('#combat_gear_body input[data-key="load"]').forEach(input => {
            const load = parseInt(input.value, 10);
            if (!isNaN(load)) {
                totalLoad += load;
            }
        });

        // 2. 单独处理防护装备
        // 获取护甲的负重值
        const armorLoadVal = parseInt(document.querySelector('#armor_slot input[data-key="load"]').value, 10);
        if (!isNaN(armorLoadVal)) {
            // 如果是矮人，负重减半并向上取整；否则使用原值
            totalLoad += isDwarf ? Math.ceil(armorLoadVal / 2) : armorLoadVal;
        }
        
        // 获取头盔的负重值
        const helmetLoadVal = parseInt(document.querySelector('#helmet_slot input[data-key="load"]').value, 10);
        if (!isNaN(helmetLoadVal)) {
            // 如果是矮人，负重减半并向上取整；否则使用原值
            totalLoad += isDwarf ? Math.ceil(helmetLoadVal / 2) : helmetLoadVal;
        }

        // 获取盾牌的负重值 (矮人特性不影响盾牌)
        const shieldLoadVal = parseInt(document.querySelector('#shield_slot input[data-key="load"]').value, 10);
        if (!isNaN(shieldLoadVal)) {
            totalLoad += shieldLoadVal; 
        }
        
        // 3. 更新页面上显示的负重值
        document.getElementById('load_val').value = totalLoad;
    }


    // --- KING OF MEN BONUS ---
    function applyKingOfMenBonus(stat) {
        if (kingOfMenBonusAppliedTo) return;
        const statInput = document.getElementById(stat + '_val');
        if (statInput) {
            statInput.value = (parseInt(statInput.value) || 0) + 1;
            kingOfMenBonusAppliedTo = stat;
            updateAttributes();
            updateKingOfMenUI();
        }
    }

    function removeKingOfMenBonus(silent = false) {
        if (!kingOfMenBonusAppliedTo) return;
        const statInput = document.getElementById(kingOfMenBonusAppliedTo + '_val');
        if(statInput) statInput.value = Math.max(0, parseInt(statInput.value) - 1);
        kingOfMenBonusAppliedTo = null;
        updateAttributes();
        if (!silent) updateKingOfMenUI();
    }

    function updateKingOfMenUI() {
        const bonusContainer = document.getElementById('king_of_men_bonus');
        const isRanger = heroicCultureSelect.value === '北方的游民';
        bonusContainer.classList.toggle('hidden', !isRanger);

        bonusContainer.querySelectorAll('button[data-stat]').forEach(btn => {
            btn.disabled = !!kingOfMenBonusAppliedTo;
        });
        document.getElementById('reset_king_bonus').disabled = !kingOfMenBonusAppliedTo;
    }

    // --- DYNAMIC REWARDS ---
    function updateRewardOptions() {
        const rewardSelects = rewardsContainer.querySelectorAll('.reward-select');
        const selectedValues = Array.from(rewardSelects).map(s => s.value).filter(v => v);

        rewardSelects.forEach(select => {
            Array.from(select.options).forEach(option => {
                if (option.value && selectedValues.includes(option.value) && option.value !== select.value) {
                    option.disabled = true;
                } else {
                    option.disabled = false;
                }
            });
        });
    }

    function updateVirtueOptions() {
        const virtueSelects = document.querySelectorAll('.virtue-select');
        const selectedValues = Array.from(virtueSelects).map(s => s.value).filter(v => v);

        virtueSelects.forEach(select => {
            Array.from(select.options).forEach(option => {
                if (option.value && selectedValues.includes(option.value) && option.value !== select.value) {
                    option.disabled = true;
                } else {
                    option.disabled = false;
                }
            });
        });
    }

    function generateRewardSelectors(count) {
        rewardsContainer.innerHTML = '';
        for (let i = 1; i <= count; i++) {
            const infoItem = document.createElement('div');
            infoItem.className = 'info-item';

            const label = document.createElement('label');
            label.setAttribute('for', `reward_select_${i}`);
            label.textContent = `勋绩 ${i}`;

            const select = document.createElement('select');
            select.id = `reward_select_${i}`;
            select.className = 'reward-select';
            select.dataset.descId = `reward_desc_${i}`;

            // Populate options
            const rewardNames = { "": "--请选择勋绩--", "贴身": "贴身 (护甲或头盔)", "精工": "精工 (护甲, 头盔或盾牌)", "致命": "致命 (武器)", "深化": "深化 (武器)", "利刃": "利刃 (武器)", "加固": "加固 (盾牌)" };
            for(const key in rewardNames) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = rewardNames[key];
                select.appendChild(option);
            }

            const descBox = document.createElement('div');
            descBox.id = `reward_desc_${i}`;
            descBox.className = 'description-box';

            infoItem.appendChild(label);
            infoItem.appendChild(select);
            infoItem.appendChild(descBox);
            rewardsContainer.appendChild(infoItem);
        }
    }

    function generateVirtueSelectors(count, culture) {
        const virtuesContainer = document.getElementById('virtues_container');
        virtuesContainer.innerHTML = '';
        
        // 获取通用美德
        const allVirtues = {...generalVirtuesData};
        
        // 如果有特定文化的美德，也添加进去
        if (culture && cultureSpecificVirtuesData[culture]) {
            Object.assign(allVirtues, cultureSpecificVirtuesData[culture]);
        }
        
        for (let i = 1; i <= count; i++) {
            const infoItem = document.createElement('div');
            infoItem.className = 'info-item';

            const label = document.createElement('label');
            label.setAttribute('for', `virtue_select_${i}`);
            label.textContent = `美德 ${i}`;

            const select = document.createElement('select');
            select.id = `virtue_select_${i}`;
            select.className = 'virtue-select';
            select.dataset.descId = `virtue_desc_${i}`;

            // Populate options
            const option = document.createElement('option');
            option.value = "";
            option.textContent = "--请选择美德--";
            select.appendChild(option);
            
            for(const key in allVirtues) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key;
                select.appendChild(option);
            }

            const descBox = document.createElement('div');
            descBox.id = `virtue_desc_${i}`;
            descBox.className = 'description-box';

            infoItem.appendChild(label);
            infoItem.appendChild(select);
            infoItem.appendChild(descBox);
            virtuesContainer.appendChild(infoItem);
        }
    }

    // --- DYNAMIC TABLE FUNCTIONS ---
    function addCombatGearRow(data = {}) {
        const tableBody = document.getElementById('combat_gear_body');
        const newRow = tableBody.insertRow();
        newRow.innerHTML = `
            <td><input type="text" data-key="name" value="${data.name || ''}" class="readonly" readonly></td>
            <td><input type="text" data-key="damage" value="${data.damage || ''}" class="readonly short-input" readonly></td>
            <td><input type="text" data-key="injury" value="${data.injury || ''}" class="readonly short-input" readonly></td>
            <td><input type="number" data-key="load" value="${data.load || ''}" class="readonly short-input" readonly></td>
            <td><input type="text" data-key="notes" value="${data.notes || ''}" class="readonly" readonly></td>
            <td><button type="button" class="remove-row-btn">移除</button></td>
        `;
    }

    // --- SAVE / LOAD ---
    function collectTableData(tableBodyId) {
        const rows = document.querySelectorAll(`#${tableBodyId} tr`);
        return Array.from(rows).map(row => {
            const rowData = {};
            row.querySelectorAll('input, select').forEach(input => {
                if (input.dataset.key) {
                    rowData[input.dataset.key] = input.value;
                }
            });
            return rowData;
        });
    }

    function saveCharacter() {
        const charData = {};
        document.querySelectorAll('input, textarea, select').forEach(element => {
            const key = element.id || element.name;
            if (key && !element.closest('.gear-table') && !element.closest('.modal-content') && !element.closest('#rewards_container')) {
                // MODIFIED: Added handling for radio buttons
                if (element.type === 'radio') {
                    if(element.checked) charData[key] = element.value;
                } else if (element.type === 'checkbox') {
                    charData[key] = element.checked;
                } else {
                    charData[key] = element.value;
                }
            }
        });
        
        charData.gameMode = document.querySelector('input[name="game_mode"]:checked').value; // MODIFIED

        charData.rewards = Array.from(rewardsContainer.querySelectorAll('.reward-select')).map(s => s.value);
        
        // 保存美德选择器的值
        charData.virtues = Array.from(document.querySelectorAll('.virtue-select')).map(s => s.value);

        document.querySelectorAll('.skill-ranks').forEach(container => {
            const ranks = [];
            container.querySelectorAll('input:checked').forEach(cb => ranks.push(cb.value));
            charData[container.id] = ranks;
        });

        charData.combatGear = collectTableData('combat_gear_body');

        charData.protectiveGear = {};
        document.querySelectorAll('#protective_gear_body tr').forEach(row => {
            const slot = row.id.replace('_slot', '');
            if (slot) {
                charData.protectiveGear[slot] = {
                    name: row.querySelector('input[data-key="name"]').value,
                    value: row.querySelector('input[data-key="value"]').value,
                    load: row.querySelector('input[data-key="load"]').value,
                    notes: row.querySelector('input[data-key="notes"]').value,
                };
            }
        });

        charData.portraitSrc = document.getElementById('portrait_preview').src;
        charData.kingOfMenBonus = kingOfMenBonusAppliedTo;
        localStorage.setItem('tor_char_sheet', JSON.stringify(charData));
        alert('人物卡已保存到浏览器！');
    }

    function loadCharacter(isSilent = false) {
        const savedData = localStorage.getItem('tor_char_sheet');
        if (savedData) {
            const charData = JSON.parse(savedData);
            
            // MODIFIED: Load game mode first
            if (charData.gameMode) {
                const modeRadio = document.querySelector(`input[name="game_mode"][value="${charData.gameMode}"]`);
                if(modeRadio) modeRadio.checked = true;
            }
            handleModeChange();


            if (kingOfMenBonusAppliedTo) {
                const oldStatInput = document.getElementById(kingOfMenBonusAppliedTo + '_val');
                if (oldStatInput) oldStatInput.value = Math.max(0, parseInt(oldStatInput.value) - 1);
            }
            kingOfMenBonusAppliedTo = charData.kingOfMenBonus || null;

            document.querySelectorAll('input, textarea, select').forEach(element => {
                 if (!element.closest('.gear-table') && !element.closest('.modal-content') && !element.closest('#rewards_container')) {
                    const key = element.id || element.name;
                    if (charData.hasOwnProperty(key)) {
                        // MODIFIED: Skip radio buttons as they are handled above
                        if(element.type === 'radio') return;

                        if (element.type === 'checkbox') { element.checked = charData[key]; }
                        else { element.value = charData[key]; }
                    }
                 }
            });

            const valor = parseInt(charData.valour) || 0;
            generateRewardSelectors(valor);
            const savedRewards = charData.rewards || [];
            const rewardSelects = rewardsContainer.querySelectorAll('.reward-select');
            rewardSelects.forEach((select, index) => {
                if (savedRewards[index]) {
                    select.value = savedRewards[index];
                    select.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            updateRewardOptions();

            // 加载美德选择器
            const wisdom = parseInt(charData.wisdom) || 0;
            const currentCulture = heroicCultureSelect.value;
            generateVirtueSelectors(wisdom, currentCulture);
            const savedVirtues = charData.virtues || [];
            const virtueSelects = document.querySelectorAll('.virtue-select');
            virtueSelects.forEach((select, index) => {
                if (savedVirtues[index]) {
                    select.value = savedVirtues[index];
                    select.dispatchEvent(new Event('change', { bubbles: true }));
                }
            });
            updateVirtueOptions();

            document.querySelectorAll('.skill-ranks').forEach(container => {
                const ranks = charData[container.id] || [];
                container.querySelectorAll('input[type="checkbox"]').forEach(cb => { cb.checked = ranks.includes(cb.value); });
            });

            document.getElementById('combat_gear_body').innerHTML = '';
            (charData.combatGear || []).forEach(rowData => addCombatGearRow(rowData));

            if (charData.protectiveGear) {
                for (const slot in charData.protectiveGear) {
                    const gearData = charData.protectiveGear[slot];
                    const targetRow = document.getElementById(`${slot}_slot`);
                    if (targetRow && gearData) {
                        targetRow.querySelector('input[data-key="name"]').value = gearData.name || '';
                        targetRow.querySelector('input[data-key="value"]').value = gearData.value || '';
                        targetRow.querySelector('input[data-key="load"]').value = gearData.load || '';
                        targetRow.querySelector('input[data-key="notes"]').value = gearData.notes || '';
                    }
                }
            }

            if (charData.portraitSrc) { document.getElementById('portrait_preview').src = charData.portraitSrc; }

            if (heroicCultureSelect.value === '北方的游民' && kingOfMenBonusAppliedTo) {
                 const statInput = document.getElementById(kingOfMenBonusAppliedTo + '_val');
                 if (statInput) statInput.value = (parseInt(statInput.value) || 0) + 1;
            }

            heroicCultureSelect.dispatchEvent(new Event('change'));
            callingSelect.dispatchEvent(new Event('change'));
            trait1Select.dispatchEvent(new Event('change'));
            trait2Select.dispatchEvent(new Event('change'));
            updateAttributes();
            updateKingOfMenUI();
            updateTotalLoad(); // UPDATE TOTAL LOAD ONCE ALL DATA IS LOADED

            if (!isSilent) alert('人物卡数据已读取！');
        } else {
            if (!isSilent) alert('未找到已保存的人物卡。');
        }
    }

    // --- POPULATE PRESETS ---
    function populateCombatGearPresets() {
        combatGearPresets.forEach(gear => {
            const option = document.createElement('option');
            option.value = gear.name;
            option.textContent = gear.name;
            combatPresetSelect.appendChild(option);
        });
    }

    // --- INITIALIZATION ---
    const skillContainers = ['skill_awe', 'skill_athletics', 'skill_awareness', 'skill_hunting', 'skill_song', 'skill_craft', 'skill_enhearten', 'skill_travel', 'skill_insight', 'skill_healing', 'skill_courtesy', 'skill_battle', 'skill_persuade', 'skill_stealth', 'skill_search', 'skill_explore', 'skill_riddle', 'skill_lore', 'prof_axes', 'prof_bows', 'prof_spears', 'prof_swords'];
    skillContainers.forEach(id => createRankCheckboxes(id));

    document.getElementById('combat_gear_body').addEventListener('click', e => {
        if (e.target.classList.contains('remove-row-btn')) {
            e.target.closest('tr').remove();
            updateTotalLoad(); // UPDATE TOTAL LOAD ON REMOVAL
        }
    });

    populateCombatGearPresets();

    // --- EVENT LISTENERS ---
    bodyVal.addEventListener('input', updateAttributes);
    bodyTN.addEventListener('input', () => updateFromTN(bodyTN, bodyVal));
    heartVal.addEventListener('input', updateAttributes);
    heartTN.addEventListener('input', () => updateFromTN(heartTN, heartVal));
    witsVal.addEventListener('input', updateAttributes);
    witsTN.addEventListener('input', () => updateFromTN(witsTN, witsVal));
    
    // MODIFIED: Added listener for game mode change
    document.querySelectorAll('input[name="game_mode"]').forEach(radio => {
        radio.addEventListener('change', handleModeChange);
    });

    heroicCultureSelect.addEventListener('change', (event) => {
        removeKingOfMenBonus(true);
        const selectedCulture = event.target.value;
        const data = cultureData[selectedCulture] || cultureData[""];
        culturalBlessingInput.value = data.blessing.name;
        culturalBlessingDesc.textContent = data.blessing.description;
        document.getElementById('char_living_standard').value = data.livingStandard;

        document.getElementById('current_endurance').value = '';
        document.getElementById('current_hope').value = '';

        trait1Select.value = '';
        trait2Select.value = '';
        populateTraitSelectors(data.traits);
        updateAttributes();
        updateKingOfMenUI();
        updateTotalLoad(); // UPDATE TOTAL LOAD ON CULTURE CHANGE
        
        // 更新美德选择器以包含特定文化的美德
        const wisdomInput = document.getElementById('wisdom');
        const wisdomCount = parseInt(wisdomInput.value) || 0;
        generateVirtueSelectors(wisdomCount, selectedCulture);
        updateVirtueOptions();
    });

    callingSelect.addEventListener('change', (event) => {
        const selectedCalling = event.target.value;
        const featureData = callingFeatures[selectedCalling] || callingFeatures[''];
        trait3Feature.value = featureData.name;
        trait3Desc.textContent = featureData.description;
    });

    valourInput.addEventListener('input', () => {
        const count = parseInt(valourInput.value) || 0;
        generateRewardSelectors(count);
        updateRewardOptions();
    });

    // 添加智慧输入框的事件监听器
    const wisdomInput = document.getElementById('wisdom');
    wisdomInput.addEventListener('input', () => {
        const count = parseInt(wisdomInput.value) || 0;
        const currentCulture = heroicCultureSelect.value;
        generateVirtueSelectors(count, currentCulture);
        updateVirtueOptions();
    });

    rewardsContainer.addEventListener('change', (e) => {
        if (e.target.matches('.reward-select')) {
            const descId = e.target.dataset.descId;
            const descBox = document.getElementById(descId);
            if (descBox) {
                descBox.innerText = rewardsData[e.target.value] || '';
            }
            updateRewardOptions();
        }
    });

    // 添加美德描述显示逻辑
    document.addEventListener('change', (e) => {
        if (e.target.matches('.virtue-select')) {
            const descId = e.target.dataset.descId;
            const descBox = document.getElementById(descId);
            if (descBox) {
                // 获取当前选择的美德名称
                const selectedVirtue = e.target.value;
                
                // 查找美德描述（先查通用美德，再查种族特定美德）
                let virtueDescription = generalVirtuesData[selectedVirtue] || '';
                
                // 如果没找到，查找当前文化特定的美德
                const currentCulture = heroicCultureSelect.value;
                if (currentCulture && cultureSpecificVirtuesData[currentCulture] && cultureSpecificVirtuesData[currentCulture][selectedVirtue]) {
                    virtueDescription = cultureSpecificVirtuesData[currentCulture][selectedVirtue];
                }
                
                descBox.innerText = virtueDescription;
            }
            updateVirtueOptions();
        }
    });

    trait1Select.addEventListener('change', updateTraitDescriptionsAndDuplicates);
    trait2Select.addEventListener('change', updateTraitDescriptionsAndDuplicates);

    document.getElementById('portrait_upload').addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = e => document.getElementById('portrait_preview').src = e.target.result;
            reader.readAsDataURL(file);
        }
    });

    document.getElementById('king_of_men_bonus').addEventListener('click', e => {
        if (e.target.matches('button[data-stat]')) {
            applyKingOfMenBonus(e.target.dataset.stat);
        } else if (e.target.matches('#reset_king_bonus')) {
            removeKingOfMenBonus();
        }
    });

    // --- MODAL LISTENERS ---
    // Combat Gear
    document.getElementById('add_combat_gear_btn').addEventListener('click', () => {
        combatGearForm.reset();
        combatPresetSelect.dispatchEvent(new Event('change'));
        combatGearModal.classList.remove('hidden');
    });
    combatGearForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const gearData = {
            name: document.getElementById('modal_combat_name').value,
            damage: document.getElementById('modal_combat_damage').value,
            injury: document.getElementById('modal_combat_injury').value,
            load: document.getElementById('modal_combat_load').value,
            notes: document.getElementById('modal_combat_notes').value
        };
        addCombatGearRow(gearData);
        combatGearModal.classList.add('hidden');
        updateTotalLoad(); // UPDATE TOTAL LOAD ON ADDITION
    });
    cancelCombatGearBtn.addEventListener('click', () => combatGearModal.classList.add('hidden'));
    combatGearModal.addEventListener('click', (e) => { if (e.target === combatGearModal) combatGearModal.classList.add('hidden'); });
    combatPresetSelect.addEventListener('change', function() {
        const selectedName = this.value;
        const selectedGear = combatGearPresets.find(gear => gear.name === selectedName);
        if (selectedGear) {
            document.getElementById('modal_combat_name').value = selectedGear.name;
            document.getElementById('modal_combat_damage').value = selectedGear.damage;
            document.getElementById('modal_combat_injury').value = selectedGear.injury;
            document.getElementById('modal_combat_load').value = selectedGear.load;
            document.getElementById('modal_combat_notes').value = selectedGear.notes;
        } else {
            combatGearForm.reset();
        }
    });

    // Protective Gear
    document.getElementById('protective_gear_body').addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('select-protective-gear-btn')) {
            currentProtectiveSlot = target.dataset.slot;
            protectiveGearForm.reset();

            protectivePresetSelect.innerHTML = '<option value="">--自定义或选择一项--</option>';
            const filteredPresets = protectiveGearPresets.filter(gear => {
                const type = gear.type.toLowerCase();
                if (currentProtectiveSlot === 'armor' && (type.includes('甲') || type.includes('衣'))) return true;
                if (currentProtectiveSlot === 'helmet' && type.includes('头')) return true;
                if (currentProtectiveSlot === 'shield' && type.includes('盾')) return true;
                return false;
            });
            filteredPresets.forEach(gear => {
                const option = document.createElement('option');
                option.value = gear.name;
                option.textContent = gear.name;
                protectivePresetSelect.appendChild(option);
            });

            protectiveGearModal.classList.remove('hidden');
        } else if (target.classList.contains('clear-protective-gear-btn')) {
            const row = target.closest('tr');
            if (row) {
                row.querySelectorAll('input[data-key]').forEach(input => {
                    input.value = '';
                });
                updateTotalLoad(); // UPDATE TOTAL LOAD ON CLEAR
            }
        }
    });

    protectiveGearForm.addEventListener('submit', (e) => {
        e.preventDefault();
        if (!currentProtectiveSlot) return;
        const gearData = {
            name: document.getElementById('modal_protective_name').value,
            value: document.getElementById('modal_protective_value').value,
            load: document.getElementById('modal_protective_load').value,
            notes: document.getElementById('modal_protective_notes').value
        };
        const targetRow = document.getElementById(`${currentProtectiveSlot}_slot`);
        if (targetRow) {
            targetRow.querySelector('input[data-key="name"]').value = gearData.name;
            targetRow.querySelector('input[data-key="value"]').value = gearData.value;
            targetRow.querySelector('input[data-key="load"]').value = gearData.load;
            targetRow.querySelector('input[data-key="notes"]').value = gearData.notes;
        }
        protectiveGearModal.classList.add('hidden');
        currentProtectiveSlot = null;
        updateTotalLoad(); // UPDATE TOTAL LOAD ON SELECTION/CHANGE
    });
    cancelProtectiveGearBtn.addEventListener('click', () => protectiveGearModal.classList.add('hidden'));
    protectiveGearModal.addEventListener('click', (e) => { if (e.target === protectiveGearModal) protectiveGearModal.classList.add('hidden'); });
    protectivePresetSelect.addEventListener('change', function() {
        const selectedName = this.value;
        const selectedGear = protectiveGearPresets.find(gear => gear.name === selectedName);
        if (selectedGear) {
            document.getElementById('modal_protective_name').value = selectedGear.name;
            document.getElementById('modal_protective_value').value = selectedGear.value;
            document.getElementById('modal_protective_load').value = selectedGear.load;
            document.getElementById('modal_protective_notes').value = selectedGear.type;
        } else {
            protectiveGearForm.reset();
        }
    });

    // --- BUTTONS ---
    document.getElementById('save-btn').addEventListener('click', saveCharacter);
    document.getElementById('load-btn').addEventListener('click', () => loadCharacter(false));
    document.getElementById('export-btn').addEventListener('click', () => window.print());
    document.getElementById('reset-btn').addEventListener('click', () => {
        if (confirm('确定要重置所有数据吗？此操作不可撤销。')) {
            // MODIFIED: Set game mode to normal
            document.getElementById('mode_normal').checked = true;
            baseTN = 20;

            const defaultZeroIds = ['body_val', 'heart_val', 'wits_val', 'fatigue_val', 'shadow_scar_val', 'valour', 'wisdom'];

            document.querySelectorAll('.character-sheet input, .character-sheet textarea, .character-sheet select').forEach(el => {
                if (el.closest('.modal-content') || el.closest('#rewards_container')) return;

                if (el.type === 'checkbox' || el.type === 'radio') {
                    // Handled separately above for game mode
                    if (el.name !== 'game_mode') el.checked = false;
                } else if (el.tagName === 'SELECT') {
                    el.selectedIndex = 0;
                } else if (!['button', 'submit', 'reset', 'file'].includes(el.type)) {
                    if (defaultZeroIds.includes(el.id)) {
                        el.value = '0';
                    } else {
                        el.value = '';
                    }
                }
            });

            rewardsContainer.innerHTML = '';

            document.getElementById('portrait_preview').src = "data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNTAiIGhlaWdodD0iMjAwIiB2aWV3Qm94PSIwIDAgMjQgMjQiIGZpbGw9Im5vbmUiIHN0cm9rZT0iIzg4OCIgc3Ryb2tlLXdpZHRoPSIxIiBzdHJva2UtbGluZWNhcD0icm91bmQiIHN0cm9rZS1saW5lam9pbj0icm91bmQiPjxwYXRoIGQ9Ik0yMCAyMWE4IDggMCAwIDAtMTYgME0xMiAxM2E0IDQgMCAxIDAgMC04IDQgNCAwIDAgMCAwIDhaIi8+PC9zdmc+";
            document.getElementById('portrait_upload').value = '';

            document.getElementById('combat_gear_body').innerHTML = '';
            document.querySelectorAll('#protective_gear_body input[data-key]').forEach(input => { input.value = ''; });

            removeKingOfMenBonus(true);

            heroicCultureSelect.dispatchEvent(new Event('change'));
            callingSelect.dispatchEvent(new Event('change'));

            localStorage.removeItem('tor_char_sheet');
            updateAttributes();
            updateKingOfMenUI();
            updateTotalLoad(); // UPDATE TOTAL LOAD ON RESET
            alert('人物卡已重置。');
        }
    });

    // --- AUTO-LOAD DATA ON PAGE STARTUP ---
    loadCharacter(true);
    // Call updateAttributes on initial load to set derived values based on defaults
    updateAttributes();

});
</script>

</body>
</html>